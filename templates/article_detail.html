{% extends 'base.html' %}
{% load static %}

{% block title %}{{ article.title }} - Healthline Clone{% endblock %}
{% block meta_description %}{{ article.excerpt }}{% endblock %}

{% block content %}
<!-- Article Header -->
<div class="article-header">
  <div class="container">
    <nav class="breadcrumb">
      <a href="{% url 'core:home' %}">Home</a>
      <span class="breadcrumb-separator">/</span>
      <a href="{% url 'core:category' article.category.slug %}">{{ article.category.name }}</a>
      <span class="breadcrumb-separator">/</span>
      <span>{{ article.title|truncatewords:5 }}</span>
    </nav>
  </div>
</div>

<!-- Article Content with Side-by-Side Layout -->
<article class="article">
  <div class="article-main">
    <div class="container">
      <div class="article-layout">
        <!-- Image on Left -->
        <div class="article-image-column">
          <img src="{{ article.get_image_url }}" alt="{{ article.title }}" class="article-featured-image">
        </div>
        
        <!-- Content on Right -->
        <div class="article-content-column">
          <span class="article-category">{{ article.category.name }}</span>
          <h1 class="article-title">{{ article.title }}</h1>
          
          <div class="article-meta">
            <div class="article-author">
              <div class="article-author-avatar-placeholder">{{ article.author|slice:":2"|upper }}</div>
              <div class="article-author-info">
                <span class="article-author-name">{{ article.author }}</span>
                <span class="article-author-title">Health Expert</span>
              </div>
            </div>
            <div class="article-details">
              <span class="article-date">{{ article.created_at|date:"F j, Y" }}</span>
              <span class="article-read-time">{{ article.read_time }} min read</span>
            </div>
          </div>
          
          <div class="article-body">
            {{ article.content|safe|linebreaks }}
          </div>
          
          <!-- Article Actions -->
          <div class="article-actions">
            {% if user.is_authenticated %}
            <!-- Like Button -->
            <button class="btn btn-outline like-article-btn {% if is_liked %}liked{% endif %}" data-article-id="{{ article.id }}">
              {% if is_liked %}
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
              </svg>
              <span class="likes-count">{{ article.likes }}</span> Liked
              {% else %}
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
              </svg>
              <span class="likes-count">{{ article.likes }}</span> Like
              {% endif %}
            </button>
            
            <!-- Save Button -->
            <button class="btn btn-outline save-article-btn {% if is_saved %}saved{% endif %}" data-article-id="{{ article.id }}">
              {% if is_saved %}
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
              </svg>
              Saved!
              {% else %}
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
              </svg>
              Save Article
              {% endif %}
            </button>
            {% else %}
            <!-- Show likes count for non-authenticated users -->
            <span class="article-likes-display">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
              </svg>
              {{ article.likes }} likes
            </span>
            {% endif %}
            <button class="btn btn-outline share-btn" onclick="copyLink(window.location.href)">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="18" cy="5" r="3"/>
                <circle cx="6" cy="12" r="3"/>
                <circle cx="18" cy="19" r="3"/>
                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
              </svg>
              Share
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</article>

<!-- Related Articles - Row Layout -->
{% if related_articles %}
<section class="related-articles">
  <div class="container">
    <h2 class="section-title">Related Articles</h2>
    <div class="related-articles-row">
      {% for related in related_articles %}
      <article class="related-article-card">
        <a href="{% url 'core:article_detail' related.slug %}" class="related-article-link">
          <img src="{{ related.get_image_url }}" alt="{{ related.title }}" class="related-article-image">
          <div class="related-article-content">
            <h3 class="related-article-title">{{ related.title }}</h3>
            <span class="related-article-meta">{{ related.read_time }} min read</span>
          </div>
        </a>
      </article>
      {% endfor %}
    </div>
  </div>
</section>
{% endif %}

<!-- Newsletter Section -->
<section class="section section-newsletter">
  <div class="container">
    <div class="newsletter-box">
      <h2>Enjoyed this article?</h2>
      <p>Subscribe to get more health tips delivered to your inbox.</p>
      <form class="newsletter-form" id="newsletter-form">
        {% csrf_token %}
        <input type="email" name="email" placeholder="Enter your email" required>
        <button type="submit" class="btn btn-primary">Subscribe</button>
      </form>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
function copyLink(url) {
  navigator.clipboard.writeText(url).then(() => {
    alert('Link copied to clipboard!');
  }).catch(err => {
    console.error('Failed to copy:', err);
  });
}

{% if user.is_authenticated %}
// Like article functionality
const likeBtn = document.querySelector('.like-article-btn');
if (likeBtn) {
  const articleId = likeBtn.dataset.articleId;
  
  likeBtn.addEventListener('click', function() {
    const btn = this;
    const csrfToken = document.querySelector('[name="csrfmiddlewaretoken"]').value;
    
    fetch(`/site/like-article/${articleId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const likesCount = btn.querySelector('.likes-count');
        if (data.liked) {
          btn.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
            </svg>
            <span class="likes-count">${data.likes_count}</span> Liked
          `;
          btn.classList.add('liked');
        } else {
          btn.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
            </svg>
            <span class="likes-count">${data.likes_count}</span> Like
          `;
          btn.classList.remove('liked');
        }
      }
    })
    .catch(err => {
      console.error('Error liking article:', err);
    });
  });
}

// Save article functionality
const saveBtn = document.querySelector('.save-article-btn');
if (saveBtn) {
  const articleId = saveBtn.dataset.articleId;
  
  saveBtn.addEventListener('click', function() {
    const btn = this;
    const csrfToken = document.querySelector('[name="csrfmiddlewaretoken"]').value;
    
    fetch(`/site/save-article/${articleId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        if (data.saved) {
          btn.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
              <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
            </svg>
            Saved!
          `;
          btn.classList.add('saved');
        } else {
          btn.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
            </svg>
            Save Article
          `;
          btn.classList.remove('saved');
        }
      }
    })
    .catch(err => {
      console.error('Error saving article:', err);
    });
  });
}
{% endif %}
</script>
{% endblock %}
